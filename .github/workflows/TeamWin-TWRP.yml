name: Build TWRP Recovery for Elephone U3H

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device Codename'
        required: false
        default: 'u3h'
      brand:
        description: 'Device Brand'
        required: false
        default: 'elephone'
      twrp_branch:
        description: 'TWRP Branch'
        required: false
        default: 'twrp-10.0'
      install:
        description: 'Install TWRP after build?'
        required: false
        default: 'false'

env:
  DEVICE: ${{ github.event.inputs.device || 'u3h' }}
  BRAND: ${{ github.event.inputs.brand || 'elephone' }}
  TWRP_BRANCH: ${{ github.event.inputs.twrp_branch || 'twrp-10.0' }}
  INSTALL: ${{ github.event.inputs.install || 'false' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip \
        curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
        x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils \
        xsltproc unzip fontconfig python3 android-tools-fsutils repo

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Initialize TWRP repository
      run: |
        mkdir -p twrp-build
        cd twrp-build
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp -b $TWRP_BRANCH --depth=1

    - name: Add MediaTek local manifest
      run: |
        cd twrp-build
        mkdir -p .repo/local_manifests
        cat > .repo/local_manifests/mediatek.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <project path="hardware/mediatek" name="LineageOS/android_hardware_mediatek" remote="github" revision="lineage-17.1" />
          <project path="vendor/mediatek" name="TeamWin/android_vendor_mediatek" remote="github" revision="android-10" />
        </manifest>
        EOF

    - name: Sync sources
      run: |
        cd twrp-build
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Copy device tree
      run: |
        cd twrp-build
        mkdir -p device/$BRAND/$DEVICE
        cp -r ../device/$BRAND/$DEVICE/* device/$BRAND/$DEVICE/

    - name: Prepare kernel and device trees
      run: |
        cd twrp-build
        mkdir -p kernel/elephone/u3h
        cp ../device/elephone/u3h/u3h_stock.dts kernel/elephone/u3h/
        
        if command -v dtc &> /dev/null; then
            dtc -I dts -O dtb -o device/elephone/u3h/dtb.img device/elephone/u3h/u3h_stock.dts || true
        fi
        
        if [ ! -f device/elephone/u3h/dtbo.img ]; then
            dd if=/dev/zero of=device/elephone/u3h/dtbo.img bs=1024 count=64
        fi

    - name: Setup build environment
      run: |
        cd twrp-build
        source build/envsetup.sh

    - name: Build TWRP with MediaTek support
      run: |
        cd twrp-build
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        export TW_USE_TOOLBOX=true
        export TW_INCLUDE_CRYPTO=true
        export TW_INCLUDE_FBE=true
        export TW_USE_FSCRYPT_POLICY=1
        export TWRP_RECOVERY_KEYMASTER_VERSION=4
        
        lunch omni_$DEVICE-eng
        mka recoveryimage -j$(nproc --all)

    - name: Upload recovery image
      uses: actions/upload-artifact@v4
      with:
        name: twrp-u3h-recovery
        path: twrp-build/out/target/product/$DEVICE/recovery.img

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-u3h
        path: twrp-build/out/error.log
